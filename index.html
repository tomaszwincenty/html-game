<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Happy Mrs. Chicken</title>
  <style>
    body {
      position: absolute;
      padding:0;
      margin:0;
      height: 100%;
      width:100%
    }
    canvas {
    background: #3AC1FB;
  }
  </style>
</head>
<body onload="onload()" onresize="resize()">

<canvas id="canvas"></canvas>

<script>
    let canvas;
    let context;
    let chicken;
    let egg;
    let imagesReady = false;
    const config = {
      spawningSpeed: 3,
      incubationTime: 3,
    };
    async function onload() {
      console.log('onload fired');
      canvas = document.getElementById('canvas');
      const loadImg = (src) => new Promise((resolve) => {
        const image = new Image();
        image.src = src;
        image.onload = () => resolve(image);
      });
      resize();
      spawnChicken(...config.inintialCoordinates);
      chicken = await loadImg('./images/kurka01.svg');
      egg = await loadImg('./images/jajo01.svg');
      imagesReady = true;
      redraw();
    }
  
  function resize() {
    canvas.width = canvas.parentNode.clientWidth;
    canvas.height = canvas.parentNode.clientHeight;
    context = canvas.getContext('2d');
    config.inintialCoordinates = [
      canvas.width/2,
      canvas.height/2,
    ];
  }

  const state = {
    actionsCounter: 0,
    chickens: [],
    eggs: [],
  }

  class Egg {
    constructor(x, y, id) {
      this.x = x;
      this.y = y;
      this.id = id;
      this.incubationStage = 0;
    }
    incubate() {
      if (this.incubationStage === config.incubationTime) {
        spawnChicken(this.x, this.y);
        this.delete();
        return;
      }
      this.incubationStage++;
      setTimeout(() => this.incubate(), 1000);
    }
    delete() {
      state.eggs[this.id] = undefined;
    }
    draw() {
      const width = 100;
      const height = 100;
      if (imagesReady) { context.drawImage(egg, this.x, this.y, width, height); }
    }
  }

  class Chicken {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.eggTimer = 0;
    }
    draw() {
      const width = 100;
      const height = 100;
      if (imagesReady) { context.drawImage(chicken, this.x, this.y, width, height); }
    }
    move(dx, dy) {
      const randomSign = () => Math.sign(Math.random()-0.5);
      this.x = this.x + randomSign()*dx;
      this.y = this.y + randomSign()*dy;
      this.eggTimer++;
    }
    layEgg () {
      if (this.eggTimer === config.spawningSpeed) {
        const newEgg = new Egg(this.x, this.y, state.eggs.length);
        newEgg.incubate();
        state.eggs.push(newEgg);
        this.eggTimer = 0;
      }
    }
  }

  function spawnChicken(x, y) {
    const newChicken = new Chicken(x, y);
    state.chickens.push(newChicken);
  }

  function action() {
    const { spawningSpeed } = config;
    state.chickens.forEach((chicken) => chicken.move(50, 50));
    state.chickens.forEach((chicken) => chicken.layEgg());
    state.actionsCounter++;
  }

  function redraw() {
    context.clearRect(0, 0, canvas.width, canvas.height);
    state.chickens.forEach((chicken) => chicken.draw());
    state.eggs.forEach((egg) => { if(egg) { egg.draw(); }});
    requestAnimationFrame(redraw);
  }

  document.addEventListener('keydown', action, false);

</script>

</body>
</html>